---
title: "Analiza smučarskih poletov - Poročilo pri predmetu Analiza podatkov s programom R"
author: "Jaša Štefan"
output:
  html_document: default
  pdf_document:
    includes:
      in_header: lib/styles.sty
    latex_engine: xelatex
runtime: shiny
---

```{r setup, echo=FALSE, results='hide', message=FALSE}
# Če želimo nastaviti pisave v PDF-ju, odkomentiramo
# in sledimo navodilom v programu.
#source("fontconfig.r", encoding = "UTF-8")

# Uvoz vseh potrebnih knjižnic
source("lib/libraries.r", encoding = "UTF-8")
```

# Izbira teme
Odločil sem se, da bom v projektu analiziral smučarske skoke, saj je to šport, ki je meni eden izmed najlubših za spremljanje, hkrati pa še ni narejenih veliko analiz na tem področju. Še posebej rad spremljam smučarske polete, zato sem se omejil in zbral podatke zgolj za tekme na letalnicah (kar pomeni, da je velikost skakalnice večja od 150m) tako v svetovnem pokalu kot na svetovnih prvenstvih v poletih. Podatki so od leta 2011 naprej, saj se pred tem še ni uporabljalo vetrne izravnave. 

Podatke sem pridobil iz uradne baze podatkov in iz wikipedie. Iz uradne baze sem dobil rezultate posameznega tekmovanja (denimo Planica, 23. marec 2017), medtem ko sem iz Wikipedie dobil podatke o državnih rekordih, poleg tega pa še nekaj tabel, ki sem jih sproti potreboval za analizo (npr. 2-mestne kratice držav). Največjo težave so mi predstavljali podatki iz FIS-a, saj so na voljo samo v PDF, tako da sem jih s programom najprej preoblikoval v xlsx ter nato uvozil v RStudio.
Najpomembnejši strani:
    * baza FIS-a: https://data.fis-ski.com/ski-jumping/results.html
    * wikipedia: https://en.wikipedia.org/wiki/Ski_jumping

Poizkušal bom ugotoviti, ali držijo nekatere moje domneve (da imajo tekmovalci iz Slovenije nižje hitrost ob doskoku), preveriti si želim tudi, ali držijo trditve slovenskih kometatorjev o nepoštenemu slogovnemu ocenjevanju. Poleg tega bom skušal zanimivo prikazati še nekatere druge podatke, denimo razvoj državnih rekordov in ocentiti njihovo gibanje v prihodnje.


# Obdelava, uvoz in čiščenje podatkov

```{r uvoz, echo=FALSE, message=FALSE}
source("uvoz/uvoz.r", encoding = "UTF-8")
```

Kot je navedeno zgoraj, sem večino podatkov o skokih dobil iz baze FIS-a (https://data.fis-ski.com/dynamic/event-details.html?event_id=39344&cal_suchsector=JP). Za vsako tekmovanje sem dobil svojo tabelo, ki je imela naslednjo obliko:
kable(head(Planica2011_sobota))
    * 1. stolpec: IME in PRIIMEK skakalca , factor
    * 2. stolpec: HITROST ob odskoku (enota m/s) , številska spremenljivka 
    * 3. stolpec: DOLŽINA (enota m) , številska spremenljivka 
    * 4. stolpec: TOČKE (za dolžino) , številska spremenljivka
    * 5.-9. stolpec: POSAMEZNE SODNIŠKE OCENE , številska spremenljivka 
    * 10. stolpec: OCENE SKUPAJ (skupne sodniške ocene) , številska spremenljivka 
    * 11. stolpec: ZALET (zaletno mesto) , številska spremenljivka 
    * 12. stolpec: TOČKE ZA ZALET (pribitek/odbitek za spremenjeno , številska spremenljivka zaletno mesto) 
    * 13. stolpec: VETER (enota m/s) , številska spremenljivka 
    * 14. stolpec: IZRAVNAVA (pribitek/odbitek zaradi vetra) , številska spremenljivka 
    * 15. stolpec: SKUPAJ TOČKE ( TOČKE + OCENE SKUPAJ + TOČKE ZA ZALET + IZRAVNAVA) , številska spremenljivka 
    * 16. stolpec: REZULTAT V SERIJI , številska spremenljivka 
    * 17. stolpec: LETO (kdaj je potekalo tekmovanje) , številska spremenljivka 
    * 18. stolpec: SKAKALNICA (kje je potekalo tekmovanje) , character 
    
Tabele sem nato najprej združil po letih (Planica2011 vsebuje podatke o tekmah v Planici v petek, soboto in nedeljo 2011). Nato sem jih združil po skakalnicah (Planica je sestavljena iz Planica2011, Planica2012, ... , Planica 2017). Na koncu pa sem naredil še dataframe, kje so zbrani vsi skoki in jo poimenoval vsi_skoki.

Podatke sem pridobil tudi iz Wikipedie, predvsem s strani https://en.wikipedia.org/wiki/Ski_jumping.
Tabela nad240 vsebuje podatke o vseh poletih, dolgih vsaj 240m . Izločil sem tiste skoke, ki niso bili doseženi na tekmi (treningi, poskusni skoki) in vzel samo uspešne skoke (izločil padce), saj sem želel opraviti analizo uspešnih skokov. Padec pomeni izgubo točk v višini približno 20 metrov, zaradi česar tak skok ne prinese vrhunske uvrstitve.
Tabela ima nasldnjo obliko: 
kable(head(nad240))
    1. stolpec: LETO , številska spremenljivka \n
    2. stolpec: SKAKALEC (ime in priimek), factor \n
    3. stolpec: DRŽAVA (od kod je skakalec), factor \n
    4. stolpec: LOKACIJA (na kateri skakalnici), factor \n
    5. stolpec: DOLŽINA (enota m) , številska spremenljivka \n   
Druga tabela, ki sem jo pridobil iz Wikipedie, je tabela državnih rekordov in je dostopna na istem naslovu. To tabelo sem moral malenkost povpraviti, saj zaradi čudne oblike tabele nekaj vrstic ni pravilno uvozilo.

Tretja tabela iz wikipedije je tabela dvomestinih kratic za države (https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2). 
    kable(head(okrajsave2))
    1. stolpec: Code2 , factor  \n
    2. stolpec: Country , character  \n
Četrta tabela iz wikipedije je tabela tromestinih kratic za države (https://en.wikipedia.org/wiki/ISO_3166-1). \n
    kable(head(okrajsave3))
    1. stolpec: Country , factor \n
    2. stolpec: Code3 , factor \n
    
```{r razpredelnice}
kable(head(druzine))
head(obcine)
```

Slika \ref{fig:histogram} prikazuje porazdelitev števila naselij v občinah.
Slika \ref{fig:porazdelitev} prikazuje porazdelitev skokov na letalnicah od leta 2011 naprej
```
ggplot(vsi_skoki,aes(x = DOLŽINA)) +
  geom_histogram(aes(y = ..density..), binwidth = 5,colour = "black", fill = "white") +
  geom_density(alpha = 0.2, fill = "#FF6666") +
  labs(x = "dolžina",y = "delež skokov") +
  scale_x_continuous(breaks = number_ticks(10))
```
```{r histogram, echo=FALSE, message=FALSE, fig.align='center', fig.cap='Histogram števila naselij v občinah'}
ggplot(obcine, aes(x = naselja)) + geom_histogram() +
  ggtitle("Pogostost števila naselij") + xlab("Število naselij") + ylab("Število občin")
```

***

# Analiza in vizualizacija podatkov

```{r vizualizacija, echo=FALSE, message=FALSE}
source("vizualizacija/vizualizacija.r", encoding = "UTF-8")
```

Slika \ref{fig:zemljevid} prikazuje povprečno velikost družine za vsako občino.

```{r zemljevid, echo=FALSE, fig.align='center', fig.cap='Zemljevid povprečnega števila otrok v družini'}
ggplot() + geom_polygon(data = left_join(zemljevid, povprecja, by = c("OB_UIME" = "obcina")),
                        aes(x = long, y = lat, group = group, fill = povprecje)) +
  ggtitle("Povprečno število otrok v družini") + xlab("") + ylab("") +
  guides(fill = guide_colorbar(title = "Povprečje"))
```
# graf2 povprečen skok po letih in skakalnici
```
ggplot(tabela,aes(x = LETO, y = DOLŽINA, col = as.factor(SKAKALNICA))) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(x = "leto", y = "povrečna dolžina", col = "skakalnica")
```
#graf3 dolžina glede na pogoje
```
ggplot(data = za_grafe,aes(x = RAZREDI, y = povprečne_razmere, col = za_grafe$SKAKALNICA),alpha = 0.01) +
  scale_color_manual(name = "Skakalnica", 
  values = c("Vikersund" = "royalblue", "Planica" = "green4","Kulm" = "orange","Obersdorf" =  "gold","Harrachov" = "red")) +
  geom_line() +
  geom_smooth(method=lm, se=FALSE) +
  labs(x = "dolžina", y = "pribitek/odbitek točk za razmere", col = "skakalnica")
```
# graf števila tekmovanj po letih
```
ggplot(tekmovanje,aes(LETO,st_tekem,fill=SKAKALNICA)) +
  geom_bar(stat="identity",width = 0.4) +
  scale_fill_brewer("SKAKALNICA", palette = "RdGy") +
  ylab("število tekem v sezoni")+ 
  scale_y_continuous(breaks= c(0,2,4,6,8)) +
  scale_x_continuous(breaks=seq(2011, 2017, 1))
```
***

# Napredna analiza podatkov

```{r analiza, echo=FALSE, message=FALSE}
source("analiza/analiza.r", encoding = "UTF-8")
```

Slika \ref{fig:graf} prikazuje povezavo med številom naselij in površino občine.

```{r graf, echo=FALSE, fig.align='center', fig.cap='Povezava med številom naselij in površino občine'}
ggplot(inner_join(obcine, data.frame(obcina = names(skupine),
                                     skupina = factor(skupine)), by = "obcina")
, aes(x = povrsina, y = naselja, color = skupina, size = prebivalci/1000)) + geom_point() +
  ggtitle("Število naselij glede na površino občine") +
  xlab(expression("Površina (km"^2 * ")")) + ylab("Št. naselij") +
  guides(color = guide_legend(title = "Skupina"),
         size = guide_legend(title = "Prebivalci (* 1000)"))
```

***

```{r shiny, echo = FALSE}
shinyAppDir("shiny", options=list(width="100%", height=600))
```
