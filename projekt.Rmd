---
title: "Analiza smučarskih poletov - Poročilo pri predmetu Analiza podatkov s programom R"
author: "Jaša Štefan"
output:
  html_document: default
  pdf_document:
    includes:
      in_header: lib/styles.sty
    latex_engine: xelatex
runtime: shiny
---

```{r setup, echo=FALSE, results='hide', message=FALSE}
# Če želimo nastaviti pisave v PDF-ju, odkomentiramo
# in sledimo navodilom v programu.
#source("fontconfig.r", encoding = "UTF-8")

# Uvoz vseh potrebnih knjižnic
source("lib/libraries.r", encoding = "UTF-8")
```

# Izbira teme
Odločil sem se, da bom v projektu analiziral smučarske skoke, saj je to šport, ki je meni eden izmed najlubših za spremljanje, hkrati pa še ni narejenih veliko analiz na tem področju. Še posebej rad spremljam smučarske polete, zato sem se omejil in zbral podatke zgolj za tekme na letalnicah (kar pomeni, da je velikost skakalnice večja od 150m) tako v svetovnem pokalu kot na svetovnih prvenstvih v poletih. Podatki so od leta 2011 naprej, saj se pred tem še ni uporabljalo vetrne izravnave. 

Podatke sem pridobil iz uradne baze podatkov in iz wikipedie. Iz uradne baze sem dobil rezultate posameznega tekmovanja (denimo Planica, 23. marec 2017), medtem ko sem iz Wikipedie dobil podatke o državnih rekordih, poleg tega pa še nekaj tabel, ki sem jih sproti potreboval za analizo (npr. 2-mestne kratice držav). Največjo težave so mi predstavljali podatki iz FIS-a, saj so na voljo samo v PDF, tako da sem jih s programom najprej preoblikoval v xlsx ter nato uvozil v RStudio.
Najpomembnejši strani:
    * baza FIS-a: https://data.fis-ski.com/ski-jumping/results.html
    * wikipedia: https://en.wikipedia.org/wiki/Ski_jumping

Poizkušal bom ugotoviti, ali držijo nekatere moje domneve (da imajo tekmovalci iz Slovenije nižje hitrost ob doskoku), preveriti si želim tudi, ali držijo trditve slovenskih kometatorjev o nepoštenemu slogovnemu ocenjevanju. Poleg tega bom skušal zanimivo prikazati še nekatere druge podatke, denimo razvoj državnih rekordov in ocentiti njihovo gibanje v prihodnje.


# Obdelava, uvoz in čiščenje podatkov

```{r uvoz, echo=FALSE, message=FALSE}
source("uvoz/uvoz.r", encoding = "UTF-8")
```

Kot je navedeno zgoraj, sem večino podatkov o skokih dobil iz baze FIS-a (https://data.fis-ski.com/dynamic/event-details.html?event_id=39344&cal_suchsector=JP). Za vsako tekmovanje sem dobil svojo tabelo, ki je imela naslednjo obliko:
kable(head(Planica2011_sobota))
    * 1. stolpec: IME in PRIIMEK skakalca , factor
    * 2. stolpec: HITROST ob odskoku (enota m/s) , številska spremenljivka 
    * 3. stolpec: DOLŽINA (enota m) , številska spremenljivka 
    * 4. stolpec: TOČKE (za dolžino) , številska spremenljivka
    * 5.-9. stolpec: POSAMEZNE SODNIŠKE OCENE , številska spremenljivka 
    * 10. stolpec: OCENE SKUPAJ (skupne sodniške ocene) , številska spremenljivka 
    * 11. stolpec: ZALET (zaletno mesto) , številska spremenljivka 
    * 12. stolpec: TOČKE ZA ZALET (pribitek/odbitek za spremenjeno , številska spremenljivka zaletno mesto) 
    * 13. stolpec: VETER (enota m/s) , številska spremenljivka 
    * 14. stolpec: IZRAVNAVA (pribitek/odbitek zaradi vetra) , številska spremenljivka 
    * 15. stolpec: SKUPAJ TOČKE ( TOČKE + OCENE SKUPAJ + TOČKE ZA ZALET + IZRAVNAVA) , številska spremenljivka 
    * 16. stolpec: REZULTAT V SERIJI , številska spremenljivka 
    * 17. stolpec: LETO (kdaj je potekalo tekmovanje) , številska spremenljivka 
    * 18. stolpec: SKAKALNICA (kje je potekalo tekmovanje) , character 
    
Tabele sem nato najprej združil po letih (Planica2011 vsebuje podatke o tekmah v Planici v petek, soboto in nedeljo 2011). Nato sem jih združil po skakalnicah (Planica je sestavljena iz Planica2011, Planica2012, ... , Planica 2017). Na koncu pa sem naredil še dataframe, kje so zbrani vsi skoki in jo poimenoval vsi_skoki.

Podatke sem pridobil tudi iz Wikipedie, predvsem s strani https://en.wikipedia.org/wiki/Ski_jumping.
Tabela nad240 vsebuje podatke o vseh poletih, dolgih vsaj 240m . Izločil sem tiste skoke, ki niso bili doseženi na tekmi (treningi, poskusni skoki) in vzel samo uspešne skoke (izločil padce), saj sem želel opraviti analizo uspešnih skokov. Padec pomeni izgubo točk v višini približno 20 metrov, zaradi česar tak skok ne prinese vrhunske uvrstitve.
Tabela ima nasldnjo obliko: 
kable(head(nad240))
    1. stolpec: LETO , številska spremenljivka \n
    2. stolpec: SKAKALEC (ime in priimek), factor \n
    3. stolpec: DRŽAVA (od kod je skakalec), factor \n
    4. stolpec: LOKACIJA (na kateri skakalnici), factor \n
    5. stolpec: DOLŽINA (enota m) , številska spremenljivka \n   
Druga tabela, ki sem jo pridobil iz Wikipedie, je tabela državnih rekordov in je dostopna na istem naslovu. To tabelo sem moral malenkost povpraviti, saj zaradi čudne oblike tabele nekaj vrstic ni pravilno uvozilo.

Tretja tabela iz wikipedije je tabela dvomestinih kratic za države (https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2). 
    kable(head(okrajsave2))
    1. stolpec: Code2 , factor  \n
    2. stolpec: Country , character  \n
Četrta tabela iz wikipedije je tabela tromestinih kratic za države (https://en.wikipedia.org/wiki/ISO_3166-1). \n
    kable(head(okrajsave3))
    1. stolpec: Country , factor \n
    2. stolpec: Code3 , factor \n
    
```{r razpredelnice}
kable(head(vsi_skoki))
kable(head(okrajsave2))
kable(head(okrajsave3))
kable(head(nad240))
kable(head(drzavni_rekordi))
```
Podatke o skokih na posameznih tekmah sem uvozil iz baze podatkov FIS-a v excel (ker so bili na voljo samo v formatu PDF) in potem v RStudio. Ostale podatke pa sem uvozil iz Wikipedije v obliki HTML.

## Preliminarna analiza

```{r vizualizacija, echo=FALSE, message=FALSE, warning=FALSE}
source("vizualizacija/vizualizacija.r", encoding = "UTF-8")
```

##### Porazdelitev skokov
Slika \ref{fig:graf1} prikazuje porazdelitev skokov na letalnicah od leta 2011 naprej. V skladu s pričakovanji dobimo, da so skoki najpogosteje dolgi okrog 200m. 
```{r graf1, echo=FALSE, message=FALSE, fig.align='center', fig.cap='Porazdelitev dolžin skokov'}
print(porazdelitev)
```
na dolgo
```
ggplot(vsi_skoki,aes(x = DOLŽINA)) +
  geom_histogram(aes(y = ..density..), binwidth = 5,colour = "black", fill = "white") +
  geom_density(alpha = 0.2, fill = "#FF6666") +
  labs(x = "dolžina",y = "delež skokov") +
  scale_x_continuous(breaks = number_ticks(10))
```
##### število tekem 
Slika \ref{fig:graf2} prikazuje število tekem v posameznem letu. Vidimo, da je število dokaj konstantno. Izjema je leto 2014, ko so bile zaradi zamude pri prenovi Planice na sporedu zgolj tri tekme.
```{r graf2, echo=FALSE, message=FALSE, fig.align='center', fig.cap='Število tekem po letih'}
print(st_tekem)
```
na dolgo
```
ggplot(tekmovanje,aes(LETO,st_tekem,fill=SKAKALNICA)) +
  geom_bar(stat="identity",width = 0.4) +
  scale_fill_brewer("SKAKALNICA", palette = "RdGy") +
  ylab("število tekem v sezoni")+ 
  scale_y_continuous(breaks= c(0,2,4,6,8)) +
  scale_x_continuous(breaks=seq(2011, 2017, 1))
```
***

# Analiza in vizualizacija podatkov

```{r vizualizacija, echo=FALSE, message=FALSE}
source("vizualizacija/vizualizacija.r", encoding = "UTF-8")
```

##### povprečen skok po letih in skakalnici
Z naslednjim grafom sem skušal prikazati, kako se z leti spreminja povprečna dolžina skokov na posameznih skakalnicah. Izkazalo se je, da se povprečje skoraj povsod povečuje, kar gre delno pripisati tudi povečeanju skakalnic.
```{r graf3, echo=FALSE, message=FALSE, fig.align='center', fig.cap='povprečna dolžina skokov'}
print(povprecen)
```

na dolgo

```
ggplot(tabela,aes(x = LETO, y = DOLŽINA, col = as.factor(SKAKALNICA))) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(x = "leto", y = "povrečna dolžina", col = "skakalnica")
```

#####  dolžina glede na pogoje
Graf \ref{fig:graf4} prikazuje, kako pogoji vplivajo na dolžino skoka. Po pričakovanjih se izkaže, da so najdaljalši skoki doseženi v dobrih razmerah in da zvišanje naleta ob slabih razmerah ne nadomesti dobrih vremenskih razmer.
```{r graf4, echo=FALSE, message=FALSE, fig.align='center', fig.cap='Porazdelitev dolžin skokov'}
print(dolzina)
```
na dolgo
```
ggplot(data = za_grafe,aes(x = RAZREDI, y = povprečne_razmere, col = za_grafe$SKAKALNICA),alpha = 0.01) +
  scale_color_manual(name = "Skakalnica", 
  values = c("Vikersund" = "royalblue", "Planica" = "green4","Kulm" = "orange","Obersdorf" =  "gold","Harrachov" = "red")) +
  geom_line() +
  geom_smooth(method=lm, se=FALSE) +
  labs(x = "dolžina", y = "pribitek/odbitek točk za razmere", col = "skakalnica")
```

### Zemljevidi

Na prvem zemljevidu sem označil vse države, za katere obstaja uradni podatek o državnem rekordu. Države so obarvane glede na to, kje je bil rekord dosežen. Zaradi večje preglednosti sem se omejil na štiri skakalnice.
```{r zemljevid1, echo=FALSE, message=FALSE, fig.align='center', fig.cap='Zemljevid prenočitev'}
print(zemljevid1)
```
na dolgo
```
ggplot() +
  geom_polygon(data = pred_for_map1, aes(x = long, y = lat, group = group, fill = place)) +
  scale_fill_brewer(name = "SKAKALNICA", palette = "Spectral", na.value = "grey50") +
  coord_quickmap(xlim = c(-153,180), ylim = c(-55,90)) +
  ditch_the_axes
```
Na drugem grafu pa so bolj podrobno predstavljeni državni rekordi evropskih držav. Dolžino rekorda označuje barva, medtem ko skakalnico določa barva meje. S sivo so označene države, za katere ni uradnih državnih rekordov.
```{r zemljevid2, echo=FALSE, message=FALSE, fig.align='center', fig.cap='Zemljevid prenočitev'}
print(zemljevidEuropa)
```
na dolgo
```
ggplot() +
  geom_polygon(data = pred_for_map1, aes(x = long, y = lat, group = group, fill = metres)) + 
  scale_fill_gradient2(name = "DRŽAVNI\nREKORD",
                      low = "cadetblue2", mid = "white", high = "green4", midpoint = 170, 
                      space = "Lab", na.value = "grey50", guide = "colourbar") +
  geom_path(data = pred_for_map1,  aes(x = long, y = lat, group = group, colour=pred_for_map1$place), size = 1) +
  scale_color_manual(name = "SKAKALNICA",
                    breaks = c("Planica", "Vikersund", "Kulm", "Harrachov", "ostalo"),
                    values = c("Planica" = "chocolate1", "Vikersund" = "orangered", "Kulm" = "gold1", "Harrachov" = "green", "ostalo" = "orchid4"))+ 
  coord_quickmap(xlim = c(-25, 40), ylim = c(32, 72))
```
***

# Napredna analiza podatkov

```{r analiza, echo=FALSE, message=FALSE}
source("analiza/analiza.r", encoding = "UTF-8")
```
***

```{r shiny, echo = FALSE}
shinyAppDir("shiny", options=list(width="100%", height=700))
```
